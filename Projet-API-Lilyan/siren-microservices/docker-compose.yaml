# ===========================================
# Configuration pour utiliser devAPI externe
# ===========================================
# PRÉREQUIS : Les conteneurs devAPI doivent être lancés AVANT
# cd ../devAPI && docker-compose up -d
# Conteneurs requis : mysql8, spark (dbcli se termine automatiquement)

services:
  # ===========================================
  # Nginx - Reverse Proxy
  # ===========================================
  nginx:
    image: nginx:alpine
    container_name: siren-nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - siren-network
      - devapi_default
    depends_on:
      - oauth2
      - api-mysql
      - api-spark

  # ===========================================
  # OAuth2 Service (Node.js)
  # ===========================================
  oauth2:
    build:
      context: ./services/oauth2
      dockerfile: Dockerfile
    container_name: siren-oauth2
    restart: unless-stopped
    expose:
      - "3000"
    environment:
      PORT: 3000
      OAUTH2_CLIENT_ID: ${OAUTH2_CLIENT_ID}
      OAUTH2_CLIENT_SECRET: ${OAUTH2_CLIENT_SECRET}
      OAUTH2_USER1: ${OAUTH2_USER1}
      OAUTH2_USER2: ${OAUTH2_USER2}
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - siren-network
      - devapi_default

  # ===========================================
  # API MySQL (Python FastAPI)
  # ===========================================
  api-mysql:
    build:
      context: ./services/api-mysql
      dockerfile: Dockerfile
    container_name: siren-api-mysql
    restart: unless-stopped
    expose:
      - "3001"
    environment:
      MYSQL_HOST: mysql8
      MYSQL_PORT: 3306
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      OAUTH2_URL: http://oauth2:3000
    depends_on:
      - oauth2
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:3001/v1/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - siren-network
      - devapi_default

  # ===========================================
  # API Spark (Python + Spark Connect)
  # ===========================================
  api-spark:
    build:
      context: ./services/api-spark
      dockerfile: Dockerfile
    container_name: siren-api-spark
    restart: unless-stopped
    expose:
      - "3002"
    environment:
      PORT: 3002
      SPARK_CONNECT_HOST: spark
      SPARK_CONNECT_PORT: 15002
      OAUTH2_URL: http://oauth2:3000
    depends_on:
      - oauth2
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:3002/v1/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - siren-network
      - devapi_default

# ===========================================
# Networks
# ===========================================
networks:
  siren-network:
    driver: bridge
  devapi_default:
    external: true  # Utilise le réseau existant de devAPI
